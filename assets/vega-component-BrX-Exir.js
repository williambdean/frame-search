import{s as _}from"./chunk-DZLz74EQ.js";import"./jotai-DDOP7CKM.js";import{t as F}from"./react-BcIddLXZ.js";import"./react-dom-D6bRRS5R.js";import"./zod-U2NFpcFA.js";import{n as E,t as G}from"./jsx-runtime-DvsdsEjx.js";import"./_Uint8Array-D5Z9rM2X.js";import"./isSymbol-xTSywenE.js";import"./toNumber-CTOPJrpu.js";import"./isArrayLikeObject-DKyJYtr8.js";import"./_getTag-CVRrQL_Q.js";import"./_baseIsEqual-BF8660ot.js";import"./merge-BgA7kxZb.js";import"./now-B6JN1xKT.js";import{t as W}from"./debounce-70y9MzDK.js";import{n as C}from"./loader-g7OmFu5O.js";import{a as I,u as x}from"./hotkeys-Lbk6RHir.js";import"./invariant-DPGusy7Z.js";import"./utils-DnJCRgaX.js";import"./constants-DIZnpo2K.js";import{n as N}from"./config-BjdJmdrN.js";import"./useEventListener-C5BS4xuN.js";import"./cn-C5VTNYKf.js";import{r as $}from"./button-nRVaalxL.js";import"./Deferred-zIiWPYX3.js";import{r as q}from"./useTheme-BMknLtnH.js";import"./createLucideIcon-DA8ZBm4D.js";import{u as R}from"./toDate-sQp07c5U.js";import"./Combination-DR4iFoRS.js";import"./dist-Cei_8ikW.js";import{t as B}from"./tooltip-BQKXsEoT.js";import"./tslib.es6-sakIzgHM.js";import{t as J}from"./isValid-BcG0nMKW.js";import"./alert-dialog-DM1h8RhU.js";import{n as O}from"./useEvent-d8iQXgui.js";import"./errors-5BnWGoql.js";import{n as U}from"./vega-loader.browser.module-B-icPEAc.js";import"./precisionRound-BIK1W-Pu.js";import"./linear-BdKgxuJR.js";import{r as m}from"./src-BIb7rCUF.js";import"./ordinal-B8Ce3bue.js";import"./time-SXziURV6.js";import"./range-DCP2k33Q.js";import"./defaultLocale-DEOAvdte.js";import"./defaultLocale-Ca1Ci3kv.js";import"./prop-types-BdSU55sL.js";import{r as X,t as Y}from"./alert-CBA2m-3_.js";import{n as Q}from"./useAsyncData-CsBCDF11.js";import"./dist-CIi_Q6L4.js";import{t as A}from"./useDeepCompareMemoize-sbXO3Z1K.js";import{n as tt}from"./error-banner-RIuTelB8.js";import"./fast-deep-equal-BmkHHxS9.js";import{t as et}from"./formats-Q84dqqph.js";import"./timer-9ePNNBwU.js";import"./path-DE1VIUo_.js";import"./math-Cpuq8NJh.js";import"./arc-K25O4dmk.js";import"./array-pmtsE1gt.js";import"./step-DCnHyPDa.js";import"./line-D2-zCSal.js";import"./init-PHOs_KoL.js";import"./colors-CmQtb3K-.js";import"./treemap-DjDHyFZi.js";import{n as rt}from"./esm-C3gGYGcG.js";var nt=_(E(),1),k=_(F(),1);function at(t){return t.data&&"url"in t.data&&(t.data.url=N(t.data.url).href),t}var K=new Set(["boxplot","errorband","errorbar"]);const g={getMarkType(t){let e=typeof t=="string"?t:t.type;if(K.has(e))throw Error("Not supported");return e},isInteractive(t){let e=typeof t=="string"?t:t.type;return!K.has(e)},makeClickable(t){let e=typeof t=="string"?t:t.type;return e in m?typeof t=="string"?{type:t,cursor:"pointer",tooltip:!0}:{...t,type:e,cursor:"pointer",tooltip:!0}:t},getOpacity(t){return typeof t=="string"?null:"opacity"in t&&typeof t.opacity=="number"?t.opacity:null}};function it(t){if(!t||!("encoding"in t))return[];let{encoding:e}=t;return e?Object.entries(e).flatMap(n=>{let[a,r]=n;return!r||!ot.has(a)?[]:"field"in r&&typeof r.field=="string"?[r.field]:"condition"in r&&r.condition&&typeof r.condition=="object"&&"field"in r.condition&&r.condition.field&&typeof r.condition.field=="string"?[r.condition.field]:[]}):[]}var ot=new Set(["color","fill","fillOpacity","opacity","shape","size"]);function st(t,e,n,a){let r={and:n.map(o=>({param:o}))};switch(t){case"opacity":{let o=g.getOpacity(a)||1;return{...e,opacity:{condition:{test:r,value:o},value:o/5}}}default:return e}}const h={point(t){return t==null?"select_point":`select_point_${t}`},interval(t){return t==null?"select_interval":`select_interval_${t}`},legendSelection(t){return`legend_selection_${t}`},HIGHLIGHT:"highlight",PAN_ZOOM:"pan_zoom",hasPoint(t){return t.some(e=>e.startsWith("select_point"))},hasInterval(t){return t.some(e=>e.startsWith("select_interval"))},hasLegend(t){return t.some(e=>e.startsWith("legend_selection"))},hasPanZoom(t){return t.some(e=>e.startsWith("pan_zoom"))}},b={highlight(){return{name:h.HIGHLIGHT,select:{type:"point",on:"mouseover"}}},interval(t,e){return{name:h.interval(e),select:{type:"interval",encodings:V(t),mark:{fill:"#669EFF",fillOpacity:.07,stroke:"#669EFF",strokeOpacity:.4},on:"[mousedown[!event.metaKey], mouseup] > mousemove[!event.metaKey]",translate:"[mousedown[!event.metaKey], mouseup] > mousemove[!event.metaKey]"}}},point(t,e){return{name:h.point(e),select:{type:"point",encodings:V(t),on:"click[!event.metaKey]"}}},legend(t){return{name:h.legendSelection(t),select:{type:"point",fields:[t]},bind:"legend"}},panZoom(){return{name:h.PAN_ZOOM,bind:"scales",select:{type:"interval",on:"[mousedown[event.metaKey], window:mouseup] > window:mousemove!",translate:"[mousedown[event.metaKey], window:mouseup] > window:mousemove!",zoom:"wheel![event.metaKey]"}}}};function V(t){switch(g.getMarkType(t.mark)){case m.image:case m.trail:return;case m.area:case m.arc:return["color"];case m.bar:{let e=lt(t);return e==="horizontal"?["y"]:e==="vertical"?["x"]:void 0}case m.circle:case m.geoshape:case m.line:case m.point:case m.rect:case m.rule:case m.square:case m.text:case m.tick:return["x","y"]}}function T(t){return"params"in t&&t.params&&t.params.length>0?t.params.filter(e=>e==null?!1:"select"in e&&e.select!==void 0).map(e=>e.name):"layer"in t?[...new Set(t.layer.flatMap(T))]:[]}function lt(t){var a,r;if(!t||!("mark"in t))return;let e=(a=t.encoding)==null?void 0:a.x,n=(r=t.encoding)==null?void 0:r.y;if(e&&"type"in e&&e.type==="nominal")return"vertical";if(n&&"type"in n&&n.type==="nominal"||e&&"aggregate"in e)return"horizontal";if(n&&"aggregate"in n)return"vertical"}function ct(t,e){var o,u;let{chartSelection:n=!0,fieldSelection:a=!0}=e;if(!n&&!a)return t;if((o=t.params)!=null&&o.some(i=>i.bind==="legend")&&(a=!1),(u=t.params)!=null&&u.some(i=>!i.bind)&&(n=!1),"vconcat"in t){let i=t.vconcat.map(s=>"mark"in s?S(s):s);return{...t,vconcat:i}}if("hconcat"in t){let i=t.hconcat.map(s=>"mark"in s?S(s):s);return{...t,hconcat:i}}if("layer"in t){let i=t.layer.map((s,d)=>{if(!("mark"in s))return s;let l=s;return l=Z(l,n,d),l=S(l),d===0&&(l=z(l)),l});return{...t,layer:i}}if(!("mark"in t)||!g.isInteractive(t.mark))return t;let r=t;return r=mt(r,a),r=Z(r,n,void 0),r=S(r),r=z(r),r}function mt(t,e){if(e===!1)return t;let n=it(t);Array.isArray(e)&&(n=n.filter(o=>e.includes(o)));let a=n.map(o=>b.legend(o)),r=[...t.params||[],...a];return{...t,params:r}}function Z(t,e,n){if(e===!1)return t;let a;try{a=g.getMarkType(t.mark)}catch{return t}if(a==="geoshape")return t;let r=e===!0?pt(a):[e];if(!r)return t;let o=r.map(i=>i==="interval"?b.interval(t,n):b.point(t,n)),u=[...t.params||[],...o];return{...t,params:u}}function z(t){let e;try{e=g.getMarkType(t.mark)}catch{}if(e==="geoshape")return t;let n=t.params||[];return n.some(a=>a.bind==="scales")?t:{...t,params:[...n,b.panZoom()]}}function S(t){let e="encoding"in t?t.encoding:void 0,n=t.params||[],a=n.map(r=>r.name);return n.length===0||!g.isInteractive(t.mark)?t:{...t,mark:g.makeClickable(t.mark),encoding:st("opacity",e||{},a,t.mark)}}function pt(t){switch(t){case"arc":case"area":return["point"];case"text":case"bar":return["point","interval"];case"line":return;default:return["point","interval"]}}async function ut(t){if(!t)return t;let e="datasets"in t?{...t.datasets}:{},n=async r=>{if(!r)return r;if("layer"in r){let i=await Promise.all(r.layer.map(n));r={...r,layer:i}}if("hconcat"in r){let i=await Promise.all(r.hconcat.map(n));r={...r,hconcat:i}}if("vconcat"in r){let i=await Promise.all(r.vconcat.map(n));r={...r,vconcat:i}}if("spec"in r&&(r={...r,spec:await n(r.spec)}),!r.data||!("url"in r.data))return r;let o;try{o=N(r.data.url)}catch{return r}let u=await C(o.href,r.data.format);return e[o.pathname]=u,{...r,data:{name:o.pathname}}},a=await n(t);return Object.keys(e).length===0?a:{...a,datasets:e}}var p=_(G(),1);U("arrow",et);var dt=t=>{let e=(0,nt.c)(11),{value:n,setValue:a,chartSelection:r,fieldSelection:o,spec:u}=t,i,s;e[0]===u?(i=e[1],s=e[2]):(i=async()=>ut(u),s=[u],e[0]=u,e[1]=i,e[2]=s);let{data:d,error:l}=Q(i,s);if(l){let y;return e[3]===l?y=e[4]:(y=(0,p.jsx)(tt,{error:l}),e[3]=l,e[4]=y),y}if(!d)return null;let f;return e[5]!==r||e[6]!==o||e[7]!==d||e[8]!==a||e[9]!==n?(f=(0,p.jsx)(ft,{value:n,setValue:a,chartSelection:r,fieldSelection:o,spec:d}),e[5]=r,e[6]=o,e[7]=d,e[8]=a,e[9]=n,e[10]=f):f=e[10],f},ft=({value:t,setValue:e,chartSelection:n,fieldSelection:a,spec:r})=>{let{theme:o}=q(),u=(0,k.useRef)(void 0),[i,s]=(0,k.useState)(),d=A(r),l=(0,k.useMemo)(()=>ct(at(d),{chartSelection:n,fieldSelection:a}),[d,n,a]),f=(0,k.useMemo)(()=>T(l),[l]),y=O(c=>{e({...t,...c})}),P=A(f),H=(0,k.useMemo)(()=>P.reduce((c,v)=>(h.PAN_ZOOM===v||(c[v]=W((w,M)=>{x.debug("[Vega signal]",w,M);let j=I.mapValues(M,gt);j=I.mapValues(j,yt),y({[w]:j})},100)),c),{}),[P,y]),L=O(c=>{x.error(c),x.debug(l),s(c)}),D=O(c=>{x.debug("[Vega view] created",c),u.current=c,s(void 0)});return(0,p.jsxs)(p.Fragment,{children:[i&&(0,p.jsxs)(Y,{variant:"destructive",children:[(0,p.jsx)(X,{children:i.message}),(0,p.jsx)("div",{className:"text-md",children:i.stack})]}),(0,p.jsxs)("div",{className:"relative",onPointerDown:$.stopPropagation(),children:[(0,p.jsx)(rt,{spec:l,theme:o==="dark"?"dark":void 0,actions:ht,signalListeners:H,onError:L,onNewView:D}),(()=>{let c=[];return h.hasPoint(f)&&c.push(["Point selection","click to select a point; hold shift for multi-select"]),h.hasInterval(f)&&c.push(["Interval selection","click and drag to select an interval"]),h.hasLegend(f)&&c.push(["Legend selection","click to select a legend item; hold shift for multi-select"]),h.hasPanZoom(f)&&c.push(["Pan","hold the meta key and drag"],["Zoom","hold the meta key and scroll"]),c.length===0?null:(0,p.jsx)(B,{delayDuration:300,side:"left",content:(0,p.jsx)("div",{className:"text-xs flex flex-col",children:c.map((v,w)=>(0,p.jsxs)("div",{children:[(0,p.jsxs)("span",{className:"font-bold tracking-wide",children:[v[0],":"]})," ",v[1]]},w))}),children:(0,p.jsx)(R,{className:"absolute bottom-1 right-0 m-2 h-4 w-4 cursor-help text-muted-foreground hover:text-foreground"})})})()]})]})},ht={source:!1,compiled:!1};function yt(t){return t instanceof Set?[...t]:t}function gt(t){return Array.isArray(t)?t.map(e=>e instanceof Date&&J(e)?new Date(e).getTime():e):t}var vt=dt;export{vt as default};
